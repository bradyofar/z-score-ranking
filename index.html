<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z-Score Ranking Calculator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f1623c;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #f1623c;
            margin-bottom: 20px;
            font-size: 32px;
        }

        .input-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f9f9f9;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
        }

        .instruction-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            display: block;
            width: 100%;
        }

        .spreadsheet-input {
            display: block;
            width: 80%;
            max-width: 1000px;
            height: 150px;
            border: 1px solid #dcdcdc;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            white-space: pre;
            overflow: auto;
            background-color: #fafafa;
            caret-color: black;
            outline: none;
            margin: 0 auto 15px auto;
        }

        .spreadsheet-input::placeholder {
            color: #888;
            font-style: italic;
            line-height: 1.5;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 15px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            background-color: #f1623c;
            color: white;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        button:hover {
            background-color: #d94d1a;
            transform: translateY(-2px);
        }

        .results {
            margin-top: 20px;
        }

        .error, .warning, .info {
            font-size: 14px;
            margin-top: 5px;
        }

        .error {
            color: #d94d1a;
        }

        .warning {
            color: #f1c40f;
        }

        .info {
            color: #2c3e50;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        #performanceResults table th, #performanceResults table td,
        #costResults table th, #costResults table td {
            width: 50%;
        }

        #overallResults table th, #overallResults table td {
            width: 25%;
        }

        th {
            background-color: #f7f4f0;
            font-weight: 600;
            color: #d94d1a;
        }

        .chart-container {
            width: 100%;
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
        }

        .chart-container canvas {
            display: block;
            max-width: 100%;
        }

        .checkbox-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .checkbox-container h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #f1623c;
            text-align: center;
            width: 100%;
        }

        .button-container h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #f1623c;
            text-align: center;
            width: 100%;
        }

        .input-section h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #f1623c;
        }

        p {
            text-align: center;
            max-width: 800px;
            margin: 0 auto 20px auto;
        }

        .distribution-plot {
            max-width: 600px;
            margin: 20px auto;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Z-Score Ranking Index</h1>
        <p class="intro-text">
            Welcome! This tool helps you compare data fairly by calculating Z-scores for your performance and cost metrics. Letâ€™s walk through the steps together!
        </p>

        <div class="checkbox-container">
            <h3>Step 1: Choose Data Transformations</h3>
            <p>
                <label>
                    <input type="checkbox" id="applyTransformations">
                    Apply Data Transformations (log transformation followed by min-max normalization)
                </label>
            </p>
        </div>

        <div class="input-section">
            <h3>Step 2: Input Your Performance Data</h3>
            <span class="instruction-text">Paste your performance data below. Include headers (e.g., Engagement rate, Click-through rates).</span>
            <div class="spreadsheet-input" contenteditable="true" id="performanceData" 
                 placeholder="Country [TAB] CTR [TAB] E/R&#10;France [TAB] 35.74% [TAB] 46.91%&#10;Germany [TAB] 15.37% [TAB] 48.66%&#10;Italy [TAB] 27.41% [TAB] 19.81%">
Country    CTR    E/R
France    0.74%    46.91%
Germany    0.37%    48.66%
Italy    0.41%    19.81%
            </div>
            <div class="button-container">
                <button onclick="calculatePerformanceZScores()">Calculate Performance Z-Scores</button>
                <div id="performanceFeedback" class="results"></div>
            </div>
        </div>

        <div id="performanceResults" class="results"></div>

        <div class="input-section">
            <h3>Step 3: Input Your Cost Data</h3>
            <span class="instruction-text">Paste your cost data below. Include headers (e.g., CPM, CPC, CPE).</span>
            <div class="spreadsheet-input" contenteditable="true" id="costData" 
                 placeholder="Country [TAB] CPM [TAB] CPC&#10;France [TAB] 1.06 [TAB] 0.45&#10;Germany [TAB] 1.13 [TAB] 0.52&#10;Italy [TAB] 1.19 [TAB] 0.48">
Country    CPM    CPC
France    1.06    0.45
Germany    1.13    0.52
Italy    1.19    0.48
            </div>
            <div class="button-container">
                <button onclick="calculateCostZScores()">Calculate Cost Z-Scores</button>
                <div id="costFeedback" class="results"></div>
            </div>
        </div>

        <div id="costResults" class="results"></div>

        <div class="button-container">
            <h3>Step 4: Get Your Overall Ranking</h3>
            <p>Click the button below to see the combined performance and cost rankings!</p>
            <button onclick="calculateOverallRanking()">Calculate Overall Ranking</button>
        </div>

        <div id="overallResults" class="results"></div>

        <div class="chart-container">
            <h3 id="chartTitle" style="text-align: center; margin-bottom: 10px;"></h3>
            <canvas id="overallChart"></canvas>
        </div>

    </div>

    <!-- Include Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let performanceZScores = [];
        let costZScores = [];
        let overallScores = [];

        function parseInputData(elementId) {
            const inputData = document.getElementById(elementId).innerText.trim();
            const rows = inputData.split('\n').filter(row => row.trim() !== '');

            const headers = rows[0].split(/\t|\s{2,}/).map(cell => cell.trim());
            rows.shift();

            const data = rows.map(row => {
                const splitRow = row.split(/\t|\s{2,}/);
                const entity = splitRow[0];
                const metrics = splitRow.slice(1).map(val => {
                    let cleanVal = val.replace('%', '').replace(',', '.').trim();
                    cleanVal = cleanVal.replace(/[^\d.-]/g, '');
                    return cleanVal === "" ? NaN : parseFloat(cleanVal);
                });
                return { entity, metrics };
            });

            let invalidCells = [];
            data.forEach((row, rowIndex) => {
                row.metrics.forEach((val, colIndex) => {
                    if (isNaN(val)) {
                        invalidCells.push(`Row ${rowIndex + 2}, Column ${headers[colIndex + 1]}`);
                    }
                });
            });

            if (invalidCells.length > 0) {
                document.getElementById(elementId).insertAdjacentHTML(
                    'afterend',
                    `<p class="error">Invalid data detected in the following cells: ${invalidCells.join(', ')}. Ensure all values in metric columns are numeric and correctly formatted.</p>`
                );
                return { headers: [], entities: [], metrics: [] };
            }

            return { headers, entities: data.map(row => row.entity), metrics: data.map(row => row.metrics) };
        }

        // Apply log transformation followed by min-max normalization if the checkbox is selected
        function preprocessData(data) {
            const applyTransformations = document.getElementById('applyTransformations').checked;

            if (applyTransformations) {
                // Apply log transformation first
                data = data.map(row => row.map(value => Math.log(value)));

                // Then apply min-max normalization
                const minValues = data[0].map((_, colIndex) => Math.min(...data.map(row => row[colIndex])));
                const maxValues = data[0].map((_, colIndex) => Math.max(...data.map(row => row[colIndex])));
                data = data.map(row => row.map((value, colIndex) => (value - minValues[colIndex]) / (maxValues[colIndex] - minValues[colIndex])));
            }

            return data;
        }

        // Calculate skewness to determine data distribution
        function calculateSkewness(data) {
            const mean = data.reduce((a, b) => a + b, 0) / data.length;
            const std = Math.sqrt(data.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / data.length);
            const skewness = (data.map(x => Math.pow((x - mean) / std, 3)).reduce((a, b) => a + b) / data.length);
            return skewness;
        }

        // Plot distribution using a histogram
        function plotDistribution(data, elementId) {
            const ctx = document.getElementById(elementId).getContext('2d');

            // Destroy previous instance if exists
            if (window[elementId + 'Instance']) {
                window[elementId + 'Instance'].destroy();
            }

            // Create a histogram by determining data bins
            const min = Math.min(...data);
            const max = Math.max(...data);
            const binCount = 10; // Number of bins in the histogram
            const binWidth = (max - min) / binCount;
            const bins = new Array(binCount).fill(0);

            data.forEach(value => {
                const binIndex = Math.min(Math.floor((value - min) / binWidth), binCount - 1);
                bins[binIndex]++;
            });

            window[elementId + 'Instance'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: bins.map((_, i) => `${(min + i * binWidth).toFixed(2)} - ${(min + (i + 1) * binWidth).toFixed(2)}`),
                    datasets: [{
                        label: 'Frequency',
                        data: bins,
                        backgroundColor: 'rgba(241, 98, 60, 0.6)',
                        borderColor: '#f1623c',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Value Ranges'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Frequency'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Display skewness information and plot data distribution if skewed
        function checkSkewness(metrics, headers, feedbackElementId) {
            const feedbackElement = document.getElementById(feedbackElementId);
            feedbackElement.innerHTML = ''; // Clear previous skewness messages

            headers.slice(1).forEach((_, colIndex) => {
                const columnData = metrics.map(row => row[colIndex]);
                const skewness = calculateSkewness(columnData);
                feedbackElement.insertAdjacentHTML('beforeend', `<p class="info">Skewness of ${headers[colIndex + 1]}: ${skewness.toFixed(2)}</p>`);

                // Display warnings and plot distribution if skewness is high
                if (Math.abs(skewness) > 1) {
                    feedbackElement.insertAdjacentHTML(
                        'beforeend',
                        `<p class="warning">Notice: The data for ${headers[colIndex + 1]} is still skewed (skewness = ${skewness.toFixed(2)}). 
                        Consider checking for outliers, applying alternative transformations (e.g., square root or reciprocal), or reviewing data entries for consistency.</p>
                        <div class="distribution-plot">
                            <canvas id="${feedbackElementId}_chart_${colIndex}"></canvas>
                        </div>`
                    );

                    // Plot the data distribution for visualization
                    setTimeout(() => plotDistribution(columnData, `${feedbackElementId}_chart_${colIndex}`), 0);
                }
            });
        }

        // Calculate mean and standard deviation for Z-score calculation
        function calculateMeanAndStd(arr) {
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            const std = Math.sqrt(arr.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / arr.length);
            return { mean, std };
        }

        // Calculate performance Z-scores
        function calculatePerformanceZScores() {
            let { headers, entities, metrics } = parseInputData('performanceData');
            metrics = preprocessData(metrics); // Apply transformations if selected
            checkSkewness(metrics, headers, 'performanceFeedback'); // Check skewness and display feedback

            if (!metrics.length || metrics.some(row => row.some(isNaN))) {
                document.getElementById('performanceFeedback').innerHTML = '<p class="error">Please enter valid numbers for performance metrics.</p>';
                return;
            }

            const zScoresByMetric = headers.slice(1).map((_, colIndex) => {
                const columnData = metrics.map(row => row[colIndex]);
                const stats = calculateMeanAndStd(columnData);
                return columnData.map(value => ((value - stats.mean) / stats.std).toFixed(6));
            });

            performanceZScores = entities.map((entity, rowIndex) => {
                const totalZScore = zScoresByMetric.reduce((sum, colZScores) => sum + parseFloat(colZScores[rowIndex]), 0);
                return { entity, totalZScore: totalZScore.toFixed(6) };
            });

            performanceZScores.sort((a, b) => b.totalZScore - a.totalZScore);
            displayResults('performanceResults', headers, performanceZScores, 'Performance');
        }

        // Calculate cost Z-scores
        function calculateCostZScores() {
            let { headers, entities, metrics } = parseInputData('costData');
            metrics = preprocessData(metrics); // Apply transformations if selected
            checkSkewness(metrics, headers, 'costFeedback'); // Check skewness and display feedback

            if (!metrics.length || metrics.some(row => row.some(isNaN))) {
                document.getElementById('costFeedback').innerHTML = '<p class="error">Please enter valid numbers for cost metrics.</p>';
                return;
            }

            const zScoresByMetric = headers.slice(1).map((_, colIndex) => {
                const columnData = metrics.map(row => row[colIndex]);
                const stats = calculateMeanAndStd(columnData);
                return columnData.map(value => -((value - stats.mean) / stats.std).toFixed(6)); // Inverting for cost metrics
            });

            costZScores = entities.map((entity, rowIndex) => {
                const totalZScore = zScoresByMetric.reduce((sum, colZScores) => sum + parseFloat(colZScores[rowIndex]), 0);
                return { entity, totalZScore: totalZScore.toFixed(6) };
            });

            costZScores.sort((a, b) => b.totalZScore - a.totalZScore);
            displayResults('costResults', headers, costZScores, 'Cost');
        }

        // Display results in a table format
        function displayResults(elementId, headers, scores, type) {
            const zScoreLabel = type === 'Performance' ? 'Performance Z-Score' : 'Cost Z-Score';

            let resultHTML = `<h3>${type} Results (Sorted by Z-Score):</h3><table>
                              <tr><th>${headers[0]}</th><th>${zScoreLabel}</th></tr>`;
            scores.forEach(item => {
                resultHTML += `<tr>
                                <td>${item.entity}</td>
                                <td>${item.totalZScore}</td>
                               </tr>`;
            });
            resultHTML += '</table>';
            document.getElementById(elementId).innerHTML = resultHTML;
        }

        // Calculate overall ranking based on performance and cost Z-scores
        function calculateOverallRanking() {
            const { headers: performanceHeaders } = parseInputData('performanceData');

            if (performanceZScores.length === 0 || costZScores.length === 0) {
                document.getElementById('overallResults').innerHTML = '<p class="error">Please calculate both performance and cost Z-scores first.</p>';
                return;
            }

            overallScores = performanceZScores.map(perf => {
                const cost = costZScores.find(c => c.entity === perf.entity);
                return {
                    entity: perf.entity,
                    performanceZ: parseFloat(perf.totalZScore),
                    costZ: parseFloat(cost ? cost.totalZScore : 0),
                    overallZ: parseFloat(perf.totalZScore) + parseFloat(cost ? cost.totalZScore : 0)
                };
            });

            overallScores.sort((a, b) => b.overallZ - a.overallZ);

            const columnAHeader = performanceHeaders[0] || 'Entity';
            let resultHTML = `<h3>Overall Performance Ranking:</h3><table>
                              <tr><th>${columnAHeader}</th><th>Performance Z-Score</th><th>Cost Z-Score</th><th>Overall Z-Score</th></tr>`;
            overallScores.forEach(item => {
                resultHTML += `<tr>
                                <td>${item.entity}</td>
                                <td>${item.performanceZ.toFixed(6)}</td>
                                <td>${item.costZ.toFixed(6)}</td>
                                <td>${item.overallZ.toFixed(6)}</td>
                               </tr>`;
            });
            resultHTML += '</table>';
            document.getElementById('overallResults').innerHTML = resultHTML;
            renderOverallChart();
        }

        // Render the overall performance chart using Chart.js
        function renderOverallChart() {
            const ctx = document.getElementById('overallChart').getContext('2d');
            const labels = overallScores.map(item => item.entity);
            const data = overallScores.map(item => item.overallZ);

            const chartTitle = 'Aggregated Z-Value Performance Index';
            document.getElementById('chartTitle').innerText = chartTitle;

            if (window.overallChartInstance) {
                window.overallChartInstance.destroy();
            }

            window.overallChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Overall Z-Score',
                        data: data,
                        backgroundColor: '#f1623c',
                        borderColor: '#f1623c',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
