<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z-Score Calculator</title>
    <style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f1623c; /* Light cream color to match the background */
    color: #333;
}

.container {
    max-width: 1200px;
    margin: 40px auto;
    padding: 20px;
    background-color: #fff; /* White background for content area */
    border-radius: 4px;

}

h1 {
    text-align: center;
    color: #f1623c; /* Orange-red color to match the theme */
    margin-bottom: 20px;
    font-size: 32px;
}



.input-section {
    display: flex;
    flex-direction: column;
    align-items: center; /* Center the content horizontally */
    margin-bottom: 30px;
    text-align: center;
}

.instruction-text {
    font-size: 18px;
    color: #333; /* Dark color for readability */
    margin-bottom: 10px;
    text-align: center;
    display: block;
    width: 100%;
}

.spreadsheet-input {
    display: block;
    width: 80%; /* Adjust width as needed for proper centering */
    max-width: 1000px; /* Optional: Limit the maximum width */
    height: 150px;
    border: 1px solid #dcdcdc;
    border-radius: 4px;
    padding: 10px;
    font-family: monospace;
    white-space: pre;
    overflow: auto;
    background-color: #fafafa;
    caret-color: black;
    outline: none;
    margin: 0 auto; /* Center the input box */
}

.spreadsheet-input::placeholder {
    color: #888;
    font-style: italic;
    line-height: 1.5;
}

.button-container {
    display: flex;
    justify-content: center;
    margin-top: 15px;
}

button {
    padding: 12px 20px;
    border: none;
    border-radius: 4px;
    background-color: #f1623c; /* Primary orange color for buttons */
    color: white;
    cursor: pointer;
    font-size: 16px;
    margin: 5px;
    transition: background-color 0.3s ease;
}

button:hover {
    background-color: #d94d1a; /* Darker shade of orange for hover effect */
}

.results {
    margin-top: 20px;
}

.error {
    color: #d94d1a; /* Red-orange for error messages */
    font-size: 14px;
    margin-top: 5px;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

th, td {
    border: 1px solid #ddd;
    padding: 12px;
    text-align: center;
    width: 50%; /* Set equal width for all columns */
}

th {
    background-color: #f7f4f0;
    font-weight: 600;
    color: #d94d1a;
}


.chart-container {
    width: 100%;
    max-width: 600px;
    margin: 40px auto;
}

.chart-container canvas {
    display: block;
    max-width: 100%;
}
    </style>
</head>
<body>
    <div class="container">
        <h1>Z-Score Calculator</h1>
        
        <div class="input-section">
            <span class="instruction-text">Paste your performance data below (including headers e.g., Engagement rate, Click-through rates):</span>
            <div class="spreadsheet-input" contenteditable="true" id="performanceData" 
                 placeholder="Country [TAB] CTR [TAB] E/R&#10;France [TAB] 35.74% [TAB] 46.91%&#10;Germany [TAB] 15.37% [TAB] 48.66%&#10;Italy [TAB] 27.41% [TAB] 19.81%">
Country    CTR    E/R
France    0.74%    46.91%
Germany    0.37%    48.66%
Italy    0.41%    19.81%
            </div>
            <div class="button-container">
                <button onclick="calculatePerformanceZScores()">Calculate Performance Z-Scores</button>
            </div>
        </div>

        <div class="input-section">
            <span class="instruction-text">Paste your cost data below (including headers e.g., CPM, CPC, CPE etc.):</span>
            <div class="spreadsheet-input" contenteditable="true" id="costData" 
                 placeholder="Country [TAB] CPM [TAB] CPC&#10;France [TAB] 1.06 [TAB] 0.45&#10;Germany [TAB] 1.13 [TAB] 0.52&#10;Italy [TAB] 1.19 [TAB] 0.48">
Country    CPM    CPC
France    1.06    0.45
Germany    1.13    0.52
Italy    1.19    0.48
            </div>
            <div class="button-container">
                <button onclick="calculateCostZScores()">Calculate Cost Z-Scores</button>
            </div>
        </div>

        <div class="button-container">
            <button onclick="calculateOverallRanking()">Calculate Overall Ranking</button>
        </div>

        <div id="performanceResults" class="results"></div>
        <div id="costResults" class="results"></div>
        <div id="overallResults" class="results"></div>

<div class="chart-container">
    <h3 id="chartTitle" style="text-align: center; margin-bottom: 10px;"></h3> <!-- Placeholder for the chart title -->
    <canvas id="overallChart"></canvas>
</div>

    </div>

    <!-- Include Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let performanceZScores = [];
        let costZScores = [];
        let overallScores = [];

function parseInputData(elementId) {
    const inputData = document.getElementById(elementId).innerText.trim();
    const rows = inputData.split('\n').filter(row => row.trim() !== '');

    // Extract headers: Assume headers are separated by tabs or multiple spaces
    const headers = rows[0].split(/\t|\s{2,}/).map(cell => cell.trim());

    // Remove the first row since it's the headers
    rows.shift();

    // Extract data with enhanced parsing: correctly handle first column with spaces
    const data = rows.map(row => {
        const splitRow = row.split(/\t|\s{2,}/); // Split by tabs or multiple spaces
        const entity = splitRow[0]; // First item is the entity name
        const metrics = splitRow.slice(1).map(val => {
            // Clean each metric value
            let cleanVal = val.replace('%', '').replace(',', '.').trim();
            cleanVal = cleanVal.replace(/[^\d.-]/g, ''); // Remove non-numeric characters
            return cleanVal === "" ? NaN : parseFloat(cleanVal); // Convert to float or NaN
        });
        return { entity, metrics };
    });

    // Validate metrics: ignore the first column (entity names)
    let invalidCells = [];
    data.forEach((row, rowIndex) => {
        row.metrics.forEach((val, colIndex) => {
            if (isNaN(val)) {
                // Identify invalid metrics, ignore the entity names
                invalidCells.push(`Row ${rowIndex + 2}, Column ${headers[colIndex + 1]}`);
            }
        });
    });

    // Display error message if invalid metrics are found
    if (invalidCells.length > 0) {
        document.getElementById(elementId).insertAdjacentHTML(
            'afterend',
            `<p class="error">Invalid data detected in the following cells: ${invalidCells.join(', ')}. Ensure all values in metric columns are numeric and correctly formatted.</p>`
        );
        return { headers: [], entities: [], metrics: [] };
    }

    // Return the parsed data with entities and metrics separated
    return { headers, entities: data.map(row => row.entity), metrics: data.map(row => row.metrics) };
}





        function calculateMeanAndStd(arr) {
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            const std = Math.sqrt(arr.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / arr.length);
            return { mean, std };
        }

        function calculatePerformanceZScores() {
            const { headers, entities, metrics } = parseInputData('performanceData');
            if (!metrics.length || metrics.some(row => row.some(isNaN))) {
                document.getElementById('performanceResults').innerHTML = '<p class="error">Please enter valid numbers for performance metrics.</p>';
                return;
            }

            const zScoresByMetric = headers.slice(1).map((_, colIndex) => {
                const columnData = metrics.map(row => row[colIndex]);
                const stats = calculateMeanAndStd(columnData);
                return columnData.map(value => ((value - stats.mean) / stats.std).toFixed(6));
            });

            performanceZScores = entities.map((entity, rowIndex) => {
                const totalZScore = zScoresByMetric.reduce((sum, colZScores) => sum + parseFloat(colZScores[rowIndex]), 0);
                return { entity, totalZScore: totalZScore.toFixed(6) };
            });

            performanceZScores.sort((a, b) => b.totalZScore - a.totalZScore);
            displayResults('performanceResults', headers, performanceZScores, 'Performance');
        }

        function calculateCostZScores() {
            const { headers, entities, metrics } = parseInputData('costData');
            if (!metrics.length || metrics.some(row => row.some(isNaN))) {
                document.getElementById('costResults').innerHTML = '<p class="error">Please enter valid numbers for cost metrics.</p>';
                return;

                  // Call displayResults to render the Cost Z-Scores table
    displayResults('costResults', headers, costZScores, 'Cost');
            }

            const zScoresByMetric = headers.slice(1).map((_, colIndex) => {
                const columnData = metrics.map(row => row[colIndex]);
                const stats = calculateMeanAndStd(columnData);
                return columnData.map(value => -((value - stats.mean) / stats.std).toFixed(6)); // Inversing Z-score
            });

            costZScores = entities.map((entity, rowIndex) => {
                const totalZScore = zScoresByMetric.reduce((sum, colZScores) => sum + parseFloat(colZScores[rowIndex]), 0);
                return { entity, totalZScore: totalZScore.toFixed(6) };
            });

            costZScores.sort((a, b) => b.totalZScore - a.totalZScore);
            displayResults('costResults', headers, costZScores, 'Cost');
        }

function displayResults(elementId, headers, scores, type) {
    // Set the column header based on the type of results
    const zScoreLabel = type === 'Performance' ? 'Performance Z-Score' : 'Cost Z-Score';

    let resultHTML = `<h3>${type} Results (Sorted by Z-Score):</h3><table>
                      <tr><th>${headers[0]}</th><th>${zScoreLabel}</th></tr>`;
    scores.forEach(item => {
        resultHTML += `<tr>
                        <td>${item.entity}</td>
                        <td>${item.totalZScore}</td>
                       </tr>`;
    });
    resultHTML += '</table>';
    document.getElementById(elementId).innerHTML = resultHTML;
}


function calculateOverallRanking() {
    // Extract the first column header from performance data
    const { headers: performanceHeaders } = parseInputData('performanceData');

    if (performanceZScores.length === 0 || costZScores.length === 0) {
        document.getElementById('overallResults').innerHTML = '<p class="error">Please calculate both performance and cost Z-scores first.</p>';
        return;
    }

    // Combine performance and cost scores into overall scores
    overallScores = performanceZScores.map(perf => {
        const cost = costZScores.find(c => c.entity === perf.entity);
        return {
            entity: perf.entity,
            performanceZ: parseFloat(perf.totalZScore),
            costZ: parseFloat(cost ? cost.totalZScore : 0),
            overallZ: parseFloat(perf.totalZScore) + parseFloat(cost ? cost.totalZScore : 0)
        };
    });

    // Sort by overall Z-score
    overallScores.sort((a, b) => b.overallZ - a.overallZ);

    // Use the extracted header for column A
    const columnAHeader = performanceHeaders[0] || 'Entity'; // Fallback to 'Entity' if header is missing
    let resultHTML = `<h3>Overall Performance Ranking:</h3><table>
                      <tr><th>${columnAHeader}</th><th>Performance Z-Score</th><th>Cost Z-Score</th><th>Overall Z-Score</th></tr>`;
    overallScores.forEach(item => {
        resultHTML += `<tr>
                        <td>${item.entity}</td>
                        <td>${item.performanceZ.toFixed(6)}</td>
                        <td>${item.costZ.toFixed(6)}</td>
                        <td>${item.overallZ.toFixed(6)}</td>
                       </tr>`;
    });
    resultHTML += '</table>';
    document.getElementById('overallResults').innerHTML = resultHTML;
    renderOverallChart();
}


        function renderOverallChart() {
            const ctx = document.getElementById('overallChart').getContext('2d');
            const labels = overallScores.map(item => item.entity);
            const data = overallScores.map(item => item.overallZ);

   	 // Set the chart title to "Z-Value Performance Index"
 	   const chartTitle = 'Z-Value Performance Index';
    	document.getElementById('chartTitle').innerText = chartTitle;
            
            // Destroy existing chart if exists
            if (window.overallChartInstance) {
                window.overallChartInstance.destroy();
            }

            // Create new chart
            window.overallChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Overall Z-Score',
                        data: data,
                        backgroundColor: '#f1623c',
                        borderColor: '#f1623c',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
